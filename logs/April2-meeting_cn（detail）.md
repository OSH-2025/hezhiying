# 4 月 2 日会议纪要

### 本次会议我们组商讨了关于软，硬件的具体形式，主要讨论了基于单核处理器的运行方式，包括程序存储、启动线程、函数传递、指令直接丢到内存中运行、任务概念、任务调度过程、线程访问权限、销毁内存泄露、系统启动后线程运行地点限制、调度问题、优先级评价、内存申请和地址调整、新的硬件模式、地址管理方式、操作系统中的线程初始化、中断处理和控制权转移等操作流程。此外，还探讨了系统在处理数据时的三种处理方式，以及内存管理的重要性。最后，还讨论了芯片之间的通信问题，包括单芯片和多芯片的通信方式，以及如何通过 msmc 连接实现芯片之间的通信。

## 主要内容：

### 系统优化与程序执行方法介绍

在会议中，讨论了使用 STM3F103 和 GT6 处理器的系统设计。目标处理器具有一兆的 flash 存储空间和 96k 的 RAM。规划中，将 96k 的空间分配给系统使用，剩余 64k 给用户程序使用。由于系统没有内置的内存和保护模式，系统和用户程序是平级的，都由同一调度器管理。具体实现方式包括：一是用户程序存储在 flash 中，通过编译链接形成可执行文件；二是用户现场生成的代码可直接在内存中运行，适用于非预编写的代码。

### 内存管理与任务调度策略解析

首先明确了任务由代码、数据和上下文三部分构成，其中数据可能存在于 flash 或内存中。调度过程中，系统可以无条件将当前线程的控制权转交给其他任务，也可以通过定时器自动回收空闲线程并转交新任务。此外，线程还有优先级之分，高优先级的线程将优先得到执行。最后，还介绍了四种线程状态，包括挂起、休眠、正常调度和 real time 模式，前三种状态是常规的多任务处理，而 real time 模式则用于保证某些严格时序要求的任务不被打断。

### 线程管理与内存换出策略讨论

主要讨论了线程的换出和换入操作，包括内存中线程的切换、外部存储器的使用及其限制，以及如何通过 fsmc 实现内存地址直接映射。同时，针对线程频繁换入换出带来的效率问题，提出了在 10 次未被调度则将其换出的策略。此外，阐述了单片机中虚拟内存的实现方式，即通过栈来保证每个线程只能访问自己的内存区域，并禁止线程创建全局变量。最后，讨论了共享变量的实现方法，系统通过 API 提供共享变量的地址，并在线程销毁时自动回收分配的内存，防止内存泄露。

### 线程调度与内存区域管理策略

主要探讨了线程运行区域的设定问题,强调了局部变量包含地址,因此不同线程不能在同一区域内运行。讨论了三种不同的线程调度模式:第一种是每个区域都有独立的线程调度,但需要注意指针地址的对应关系;第二种是所有线程共享 64k 空间,由片外存储器映射形成,效率较高,但需要频繁交换数据;第三种是按照优先级设定不同区域的线程调度,能提高效率,但需要用户指定优先级。同时,还对抢占式与非抢占式的调度进行了讨论。

### 内存管理与指针操作优化策略

针对内存申请和指针操作问题,提出了第四种模式。在这种模式中,系统会自动申请所需内存并对指针操作进行地址调整。然而,这种方式可能会降低内存访问速度,因为每次访问内存都需要加上特定的数量。此外,中间映射过程可能会耗费大量时间,特别是在高频情况下,如复制数据时需不断进行读写操作,这将导致整体效率降低。

### 实现硬件模式下的多任务切换

主要讨论了硬件的使用和管理，包括在硬件中使用外设空间，将系统内的 64k 空间用于维护结构，并将片外的存储器用于用户。同时，介绍了 Smc 的特点，即只暴露给芯片，只访问 16 条地址线，从而实现多任务切换。文中还详细阐述了如何通过改变三条地址线，实现在内存大空间中选择其中的一半。最后，强调了系统的内存地址管理单元的重要性，并指出其符合内测管理的要求。讨论了一种新的方案，该方案无需额外的物质开销，只需将所有用户程序交给系统，并在系统中创建接口，并使用小字体缩写。系统会产生大量接口，用户可以通过查询表来确定接口的位置和调度方式。同时，系统中的线程号是递增的，这意味着信号不会处理，但每个运行周期都不会。此外，系统中的所有部件都是通过中断实现的，用户可以直接在组函数中添加一些东西。

### 系统调度与线程控制权转交策略

主要讲解了系统调用、实时性和用户程序控制权转交给系统的三种方式。首先，所有的系统调用都依赖于一毫秒一次的中断，在每次中断发生时，系统将在短时间内处理完所有任务，然后返回给用户现场。其次，系统有三种方式获取控制权，包括终端系统首先获得、通过特殊一毫秒中断以及用户显示调用函数。最后，系统在运行过程中应避免被其他事情打扰，但遇到更紧急的外部中断时，系统必须响应。此外，还介绍了一种看门狗定时器机制，当线程长时间未被调度时，系统会认为可能存在问题并采取相应措施。

### 多线程编程中的程序执行与状态跟踪

讨论了程序执行过程中，线程切换和函数调用的问题。针对多个函数嵌套的情况，提出了如何存储和恢复线程的执行位置的问题。使用程序指针作为保存执行位置的一种方式，系统在中断处理时会自动保存 PC 并在恢复时将其恢复。此外，还详细解释了一个被调度的完整过程。

### 线程返回处理与内存管理策略讨论

系统如何处理线程返回和内存管理的问题。首先，当一个线程返回时，它会回到系统，并由系统进行清理工作，包括释放该线程占用的内存资源等。其次，用户可以通过设置系统 flag,请求系统在线程返回后帮忙擦除数据，而不仅仅是将分配给它的内存区域全部变成 0。此外，系统可以设立一个优先级最低的线程，在所有其他线程都未需要被调度的时候进行内存空白区域的清理工作。最后，讨论了动态分配内存时可能遇到的问题以及对应的解决方案，如通过改变存储器位图来实现共享内存区域的管理。

### 芯片内外内存管理及全局变量使用讨论

主要探讨了芯片内部的 4032 与外部内存的实现方式,并解释了用户在购买开发板时,为何板子背面会预留一个焊芯片的位置。同时,对于内存管理的问题,强调了线程自己的事情自己处理,用户程序只需让其能访问到所需区域即可。最后,讨论了全局变量的使用风险,不提倡使用全局变量以避免数据不一致引发的问题。

### 系统同步与多线程管理策略讨论

主要讨论了系统在单核与多核环境下的工作模式，以及如何实现同步多线程的同步锁信号量。对于外设管理，提出了使用中断系统进行资源保护的策略。同时，强调了网络概念在模拟中的重要作用，并对如何在芯片间建立连接进行了探讨。此外，也对外设的使用和数据传输方式进行了详细解释。

### 芯片间通信与单芯片优化策略讨论

讨论了多芯片通信和单片机机械臂设计的实现过程。首先,虽然目前多芯片之间的通信并无太大实际作用,但为未来改进留下了空间。在设计上,应先确保芯片间的通信正常运行,然后再考虑如何利用片外存储器和哈佛实现芯片间访问。同时,由于硬件资源有限,需要优化设计,如减少信号线数量,并考虑在单芯片上实现独占内存。此外,通过串口通信和共享内存是实现大块数据存储的关键步骤。最后,尽管面临挑战,但通过合理规划和优化,仍有可能在有限资源上成功设计出功能强大的系统。

### 优化操作系统资源管理与通信效率

讨论主要围绕操作系统(OS)的运行方式以及其在多任务处理中的作用。其中,提到了通过牺牲一个壳来调版并进行管道贴合的策略,以实现对 OS 的预测和控制。同时,强调了其他技术在 OS 运行时会被暂停,而双核系统能够实现同时运行多个任务。此外,还探讨了将所有操作都交由 OS 处理可能带来的效率问题,以及通信过程中信息传递的方式和效率。
