# 可行性报告： 物联网应用中使用多个 STM32F101 微控制器的并行计算系统

## 目标

本报告评估在设备中使用多个 STM32F103 微控制器构建并行计算系统的可行性，目解决目前复杂的嵌入式系统（例如机器人比赛使用的机器人）中使用单个 MCU 无法完成真并行任务，而用 MPU / SoC 又极大增加复杂度的问题。该系统预计将通过使用 FSMC 的外部 RAM 支持多任务处理，通过 USART 支持高速通信，并通过自行开发的 C 语言操作系统进行任务管理。

## STM32F103 处理器

STM32F103 是 STM32F1 系列单片机的一种，使用 32 位的 ARM Cortex-M3 核心。可以运行在 ~72MHz 的主频下，并具有最大 1MB 的 Flash 存储器、96KB 的内部高速 SRAM（我们使用的 STM32F103ZGT6 具有这些配置）。通过片上 FSMC 控制器，可以将地址区域的一部分映射到外部 RAM 或者 Flash，实现存储空间的扩展和多任务共用地址区间的能力。此外，该单片机还有多个 USART 接口，并有多个定时器，可以实现片间通信和多任务切换所需要的中断功能。

## 并行计算

通过两级多任务分配，可以在多个 STM32F103 处理器上运行多个任务。

- 一级多任务（片内切换实现）：通过片内定时器控制的任务切换，实现伪多任务，这对于非实时任务而言是合适的。
- 二级多任务（多处理器）：多个处理器可以真正运行同时多任务。

## USART 通信

STM32 处理器提供多个 USART，其中 USART1 最大可达 72MHz 通信速率，相当于近 9MByte/s，可以实现多个片间的消息传递。通过简单的数据包协议，可以对 USART 上的数据传输进行控制。多个 STM32 处理器共用外部的 USART Switch 实现数据包的自动转发。

## 操作系统

使用 C 语言编写简单的操作系统，实现下列功能：

- 多任务
    - 默认抢占式多任务
    - 通过 FSMC 外挂 RAM 的不同区域实现内存切换 (paging)
    - 提供局部实时 (realtime)，方便一些有时序需求的任务
    - 优先级控制
    - 可以主动调度
- 通信
    - 类 Socket 的统一消息传递机制，片内 & 片间
    - 共享内存传递大块数据
    - DMA 可以帮助处理大块数据
- 实时功能
    - 部分内部/外部中断转发给用户程序
- 外设
    - OS 实现外设硬件的抽象
    - 对用户程序提供 API
- 

## 总结

可行性：该概念适用于需要分布式处理的中小型物联网项目。它适用于教育用途、业余爱好者项目和实验性物联网平台。

优势：

- 模块化和可扩展设计。
- 低成本硬件。
- 通过自写操作系统和通信协议实现高度定制。

挑战

- 缺乏真正多核系统的性能。
- 没有内存的保护模式 (protected mode)
- 定制软件开发和测试工作量大。
- 通信和同步开销会影响性能。
